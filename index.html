<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Index PRO+ â€“ TikTok Feed Intelligence</title>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
header{background:#020617;color:#fff;padding:20px}
.container{max-width:1500px;margin:auto;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
.stat{font-size:30px;font-weight:900}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;background:#e5e7eb}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #eee}
th{background:#f8fafc}
.rank{font-weight:900}
.foi{font-size:22px;font-weight:900}
button,input,select,textarea{
  padding:10px;border-radius:10px;border:1px solid #cbd5f5
}
button{background:#020617;color:#fff;cursor:pointer}
button.secondary{background:#475569}
button.danger{background:#dc2626}
textarea{width:100%;min-height:160px}
small{color:#64748b}
hr{border:none;border-top:1px solid #e5e7eb;margin:12px 0}
.flex{display:flex;align-items:center;justify-content:space-between;gap:10px}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <h1>ğŸš€ Index PRO+ â€“ Feed Opportunity Index</h1>
  <small>Kalodata-style | Affiliate Intelligence | No API</small>
</header>

<div class="container">

<!-- DASHBOARD -->
<div class="grid">
  <div class="card"><h3>ğŸ“¦ à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</h3><div class="stat" id="total">0</div></div>
  <div class="card"><h3>ğŸš€ FOI â‰¥ 75</h3><div class="stat" id="easy">0</div></div>
  <div class="card"><h3>ğŸ’° ROI à¸ªà¸¹à¸‡</h3><div class="stat" id="roiHigh">0</div></div>
  <div class="card"><h3>ğŸ”¥ à¸«à¸¡à¸§à¸”à¸¡à¸²à¹à¸£à¸‡</h3><div class="stat" id="topCat">-</div></div>
</div>

<br>

<!-- FILTER -->
<div class="card">
  <input id="search" placeholder="à¸„à¹‰à¸™à¸«à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²">
  <select id="catFilter"></select>
  <button onclick="apply()">Filter</button>
  <button class="secondary" onclick="alert('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰ Export CSV')">
  Export CSV
  </button>
  <button class="danger" onclick="clearData()">ğŸ§¹ à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
</div>

<br>

<!-- CATEGORY MANAGER (COLLAPSE) -->
<div class="card">
  <div class="flex">
    <h3>ğŸ—‚ à¸ˆà¸±à¸”à¸à¸²à¸£à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ</h3>
    <button class="secondary" id="catToggle">â•</button>
  </div>

  <div id="catPanel" class="hidden">
    <br>
    <input id="catName" placeholder="à¸Šà¸·à¹ˆà¸­à¸«à¸¡à¸§à¸” à¹€à¸Šà¹ˆà¸™ Topper Premium">
    <input id="catRegex" placeholder="Keyword / Regex à¹€à¸Šà¹ˆà¸™ topper|à¸—à¹‡à¸­à¸›à¹€à¸›à¸­à¸£à¹Œ">
    <button onclick="addCategory()">â• à¹€à¸à¸´à¹ˆà¸¡à¸«à¸¡à¸§à¸”</button>
    <hr>
    <div id="catList"></div>
  </div>
</div>

<br>

<!-- TABLE -->
<div class="card">
<table>
<thead>
<tr>
<th>#</th><th>à¸ªà¸´à¸™à¸„à¹‰à¸²</th><th>à¸«à¸¡à¸§à¸”</th>
<th>FOI</th><th>ROI</th><th>Sell</th><th>Feed</th><th>à¸ªà¸–à¸²à¸™à¸°</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>
</div>

<br>

<!-- GPT -->
<div class="card">
  <h3>ğŸ§  Send to GPT</h3>
  <textarea id="gptPrompt"></textarea>
  <button onclick="sendToGPT()">ğŸ“¤ Copy & Open ChatGPT</button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const DB_ROOT="https://index-pro-tiktok-default-rtdb.asia-southeast1.firebasedatabase.app";
const IMPORT_PATH="/imports.json";

/* ================= CATEGORY ================= */
const CAT_KEY="INDEX_PRO_CATEGORIES";
const CAT_UI_KEY="INDEX_PRO_CAT_OPEN";

const DEFAULT_CATS=[
  {name:"Topper",regex:"topper|à¸—à¹‡à¸­à¸›à¹€à¸›à¸­à¸£à¹Œ"},
  {name:"à¸œà¹‰à¸²à¸›à¸¹à¸—à¸µà¹ˆà¸™à¸­à¸™",regex:"à¸œà¹‰à¸²à¸›à¸¹|bed sheet"},
  {name:"à¸«à¸¡à¸­à¸™",regex:"à¸«à¸¡à¸­à¸™|pillow"},
  {name:"à¸œà¹‰à¸²à¸«à¹ˆà¸¡",regex:"à¸œà¹‰à¸²à¸«à¹ˆà¸¡|blanket"},
  {name:"Premium Bedding",regex:"premium"}
];

let CATEGORIES=JSON.parse(localStorage.getItem(CAT_KEY))||DEFAULT_CATS;
let DATA=[];

/* ================= COLLAPSE LOGIC ================= */
const catPanel=document.getElementById("catPanel");
const catToggle=document.getElementById("catToggle");

let isCatOpen = localStorage.getItem(CAT_UI_KEY)==="1";

function renderCatUI(){
  catPanel.classList.toggle("hidden",!isCatOpen);
  catToggle.innerText=isCatOpen?"â–":"â•";
}

catToggle.onclick=()=>{
  isCatOpen=!isCatOpen;
  localStorage.setItem(CAT_UI_KEY,isCatOpen?"1":"0");
  renderCatUI();
};

/* ================= CATEGORY CRUD ================= */
function saveCat(){
  localStorage.setItem(CAT_KEY,JSON.stringify(CATEGORIES));
  renderCatManager();
  reloadCategory();
}

function addCategory(){
  if(!catName.value||!catRegex.value) return alert("à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");
  CATEGORIES.unshift({name:catName.value,regex:catRegex.value});
  catName.value="";catRegex.value="";
  saveCat();
}

function removeCategory(i){
  if(!confirm("à¸¥à¸šà¸«à¸¡à¸§à¸”à¸™à¸µà¹‰?")) return;
  CATEGORIES.splice(i,1);
  saveCat();
}

function renderCatManager(){
  catList.innerHTML="";
  CATEGORIES.forEach((c,i)=>{
    catList.innerHTML+=`
      <div class="flex">
        <div><strong>${c.name}</strong> <small>(${c.regex})</small></div>
        <button class="danger" onclick="removeCategory(${i})">à¸¥à¸š</button>
      </div>`;
  });
}

/* ================= CATEGORY AUTO ================= */
function autoCategory(name="",price=0){
  name=name.toLowerCase();
  for(const c of CATEGORIES){
    if(new RegExp(c.regex,"i").test(name)) return c.name;
  }
  if(price>1000) return "Premium Bedding";
  return "Home & Sleep";
}

/* ================= SCORE ================= */
const sellScore=p=>Math.round(Math.min((p.avgViews||0)/1200,30)+Math.min((p.engagement||0)*4,30));
const feedScore=p=>Math.round(Math.min((p.avgViews||0)/1000,30)+Math.min((p.engagement||0)*5,25));
const FOI=p=>Math.round(sellScore(p)*0.4+feedScore(p)*0.6);
const roiScore=p=>Math.round(p.foi*0.6+(p.engagement||0.1)*20);

/* ================= LOAD ================= */
async function load(){
  const r=await fetch(DB_ROOT+IMPORT_PATH);
  const json=await r.json();
  DATA=[];
  if(!json) return;
  Object.values(json).forEach(b=>{
    (b.items||[]).forEach(p=>{
      p.category=autoCategory(p.name,p.price);
      p.sell=sellScore(p);
      p.feed=feedScore(p);
      p.foi=FOI(p);
      p.roi=roiScore(p);
      DATA.push(p);
    });
  });
  reloadCategory();
}

/* ================= UI ================= */
function reloadCategory(){
  dashboard();filterCat();render(DATA);buildGPT();
}

function dashboard(){
  total.innerText=DATA.length;
  easy.innerText=DATA.filter(p=>p.foi>=75).length;
  roiHigh.innerText=DATA.filter(p=>p.roi>=70).length;
  const c={};DATA.forEach(p=>c[p.category]=(c[p.category]||0)+1);
  topCat.innerText=Object.entries(c).sort((a,b)=>b[1]-a[1])[0]?.[0]||"-";
}

function filterCat(){
  catFilter.innerHTML='<option value="">à¸—à¸¸à¸à¸«à¸¡à¸§à¸”</option>';
  [...new Set(DATA.map(p=>p.category))].forEach(c=>catFilter.innerHTML+=`<option>${c}</option>`);
}

function apply(){
  const q=search.value.toLowerCase(),c=catFilter.value;
  render(DATA.filter(p=>(!q||p.name.toLowerCase().includes(q))&&(!c||p.category===c)));
}

function render(list){
  tb.innerHTML="";
  list.sort((a,b)=>b.foi-a.foi).forEach((p,i)=>{
    tb.innerHTML+=`
<tr>
<td>#${i+1}</td>
<td>${p.name}<br><small>${p.shop||""}</small></td>
<td><span class="badge">${p.category}</span></td>
<td class="foi">${p.foi}</td>
<td>${p.roi}</td>
<td>${p.sell}</td>
<td>${p.feed}</td>
<td>${p.roi>=70?"ğŸ’°":"âš ï¸"}</td>
</tr>`;
  });
}

/* ================= GPT ================= */
function buildGPT(){
  gptPrompt.value=DATA.slice(0,10).map((p,i)=>`${i+1}. ${p.name} (${p.category}) FOI:${p.foi}`).join("\n");
}
function sendToGPT(){
  navigator.clipboard.writeText(gptPrompt.value);
  window.open("https://chat.openai.com","_blank");
}

/* ================= CLEAR ================= */
async function clearData(){
  if(!confirm("à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”?"))return;
  await fetch(DB_ROOT+IMPORT_PATH,{method:"DELETE"});
  DATA=[];reloadCategory();
}

/* ================= INIT ================= */
renderCatUI();        // ğŸ”’ à¸‹à¹ˆà¸­à¸™/à¹à¸ªà¸”à¸‡à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
renderCatManager();
load();
</script>

</body>
</html>
